<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized AI TTS</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #111; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 40px; }
        .container { background: #222; padding: 30px; border-radius: 12px; width: 100%; max-width: 600px; }
        
        textarea { width: 100%; height: 100px; background: #333; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; margin-bottom: 20px; }
        
        button { background: #00ff88; color: #000; border: none; padding: 12px; font-weight: bold; border-radius: 6px; cursor: pointer; width: 100%; }
        button:disabled { background: #555; cursor: wait; opacity: 0.7; }

        /* Progress Bar Styles */
        .progress-container { margin-top: 15px; width: 100%; background: #333; border-radius: 4px; height: 10px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: #00ff88; width: 0%; transition: width 0.2s; }
        
        .status { margin-top: 10px; font-size: 13px; color: #aaa; text-align: center; }
    </style>
</head>
<body>

    <h1>AI Text-to-Speech (Optimized)</h1>
    <div class="container">
        <textarea id="text-input">Hello, this model is pre-loaded for better performance.</textarea>
        
        <button id="generate-btn" onclick="generateSpeech()" disabled>Loading Model...</button>
        
        <div id="progress-container" class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <div id="status" class="status">Initializing...</div>
        
        <audio id="audio-player" controls style="width: 100%; margin-top: 20px; display: none;"></audio>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';

        // 1. Force Cache: Lần tải thứ 2 sẽ tức thì
        env.useBrowserCache = true;
        env.allowLocalModels = false;

        const status = document.getElementById('status');
        const btn = document.getElementById('generate-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const audioPlayer = document.getElementById('audio-player');

        let synthesizer = null;
        let speaker_embeddings = null;
        
        // URL giọng đọc (Cached)
        const SPEAKER_URL = 'https://huggingface.co/datasets/Xenova/transformers.js-docs/resolve/main/speaker_embeddings.json';

        // 2. Pre-load Function: Chạy ngay khi mở web
        async function preloadModel() {
            progressContainer.style.display = 'block';
            status.textContent = "Downloading AI Model (Client-side)...";

            try {
                // Tải model với Callback theo dõi tiến độ
                synthesizer = await pipeline('text-to-speech', 'Xenova/speecht5_tts', {
                    quantized: true, // Bắt buộc dùng Quantized để nhẹ (40MB vs 150MB)
                    progress_callback: (data) => {
                        // Cập nhật thanh loading
                        if (data.status === 'progress') {
                            const percent = Math.round(data.progress || 0);
                            progressBar.style.width = percent + '%';
                            status.textContent = `Downloading ${data.file}: ${percent}%`;
                        }
                    }
                });

                // Tải Embeddings song song hoặc ngay sau
                status.textContent = "Loading Voice Profiles...";
                const response = await fetch(SPEAKER_URL);
                const speakerData = await response.json();
                speaker_embeddings = speakerData['cmu_us_slt_arctic-wav-arctic_a0001'];

                // Hoàn tất
                status.textContent = "System Ready.";
                status.style.color = "#00ff88";
                progressContainer.style.display = 'none';
                btn.disabled = false;
                btn.textContent = "Generate Audio";

            } catch (err) {
                status.textContent = "Error: " + err.message;
                status.style.color = "red";
            }
        }

        // 3. Tự động kích hoạt Pre-load
        window.addEventListener('DOMContentLoaded', preloadModel);

        window.generateSpeech = async function() {
            const text = document.getElementById('text-input').value;
            if (!text || !synthesizer) return;

            btn.disabled = true;
            btn.textContent = "Synthesizing...";
            
            try {
                // Inference
                const output = await synthesizer(text, { speaker_embeddings });
                
                // Play Audio
                const wavUrl = createWavUrl(output.audio, output.sampling_rate);
                audioPlayer.src = wavUrl;
                audioPlayer.style.display = 'block';
                await audioPlayer.play();
                
            } catch (err) {
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = "Generate Audio";
            }
        };

        // Hàm tạo file WAV (Helper)
        function createWavUrl(audio, sampleRate) {
            const buffer = new ArrayBuffer(44 + audio.length * 2);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + audio.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, audio.length * 2, true);
            for (let i = 0; i < audio.length; i++) {
                let s = Math.max(-1, Math.min(1, audio[i]));
                view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return URL.createObjectURL(new Blob([view], { type: 'audio/wav' }));
        }
    </script>
</body>
</html>
