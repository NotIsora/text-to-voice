<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI TTS Tiếng Việt (Fixed)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 40px; }
        .container { background: #2b2b2b; padding: 30px; border-radius: 12px; width: 100%; max-width: 600px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        textarea { width: 100%; height: 100px; background: #333; border: 1px solid #444; color: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; font-size: 16px; resize: none; }
        textarea:focus { outline: none; border-color: #00ff88; }
        
        button { background: #00ff88; color: #000; border: none; padding: 12px; font-weight: bold; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; transition: 0.2s; }
        button:hover { background: #00cc6a; }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }

        .progress-bar { height: 6px; background: #00ff88; width: 0%; transition: width 0.2s; margin-top: 15px; border-radius: 3px; }
        .status { margin-top: 10px; font-size: 13px; color: #aaa; text-align: center; min-height: 20px; }
        
        audio { width: 100%; margin-top: 20px; display: none; }
    </style>
</head>
<body>

    <h1>AI Đọc Tiếng Việt</h1>
    <div class="container">
        <textarea id="text-input">Xin chào, tôi là trí tuệ nhân tạo chuyển đổi văn bản thành âm thanh do Đoàn Thiên An vibe coding.</textarea>
        
        <button id="generate-btn" onclick="generateSpeech()" disabled>Đang tải mô hình...</button>
        
        <div class="progress-bar" id="progress-bar"></div>
        <div id="status" class="status">Đang khởi tạo...</div>
        
        <audio id="audio-player" controls></audio>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';

        // Tối ưu cache để lần sau load tức thì
        env.useBrowserCache = true;
        env.allowLocalModels = false;

        const status = document.getElementById('status');
        const btn = document.getElementById('generate-btn');
        const progressBar = document.getElementById('progress-bar');
        const audioPlayer = document.getElementById('audio-player');

        let synthesizer = null;

        // Tự động tải model ngay khi mở trang
        async function preloadModel() {
            try {
                status.textContent = "Đang tải mô hình (Khoảng 20-30MB)...";
                
                // Sử dụng model Tiếng Việt: Xenova/mms-tts-vie
                synthesizer = await pipeline('text-to-speech', 'Xenova/mms-tts-vie', {
                    quantized: true, // Bản nhẹ
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            const percent = Math.round(data.progress || 0);
                            progressBar.style.width = percent + '%';
                            if(percent < 100) status.textContent = `Đang tải: ${percent}%`;
                        }
                    }
                });

                status.textContent = "Sẵn sàng!";
                status.style.color = "#00ff88";
                btn.textContent = "Đọc văn bản";
                btn.disabled = false;
                progressBar.style.width = '100%';
                setTimeout(() => { progressBar.style.opacity = '0'; }, 1000);

            } catch (err) {
                console.error(err);
                status.textContent = "Lỗi tải model: " + err.message;
                status.style.color = "red";
            }
        }

        // Gọi hàm preload
        preloadModel();

        window.generateSpeech = async function() {
            const text = document.getElementById('text-input').value;
            if (!text || !synthesizer) return;

            btn.disabled = true;
            btn.textContent = "Đang xử lý...";
            status.textContent = "Đang tạo âm thanh...";
            status.style.color = "#aaa";

            try {
                // Inference: KHÔNG cần speaker_embeddings nữa
                const output = await synthesizer(text);
                
                // Tạo file WAV và phát
                const wavUrl = createWavUrl(output.audio, output.sampling_rate);
                audioPlayer.src = wavUrl;
                audioPlayer.style.display = 'block';
                await audioPlayer.play();
                status.textContent = "Hoàn tất.";

            } catch (err) {
                console.error(err);
                status.textContent = "Lỗi: " + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = "Đọc văn bản";
            }
        };

        // Hàm chuyển đổi Audio Buffer sang WAV (Helper)
        function createWavUrl(audio, sampleRate) {
            const buffer = new ArrayBuffer(44 + audio.length * 2);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + audio.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, audio.length * 2, true);
            for (let i = 0; i < audio.length; i++) {
                let s = Math.max(-1, Math.min(1, audio[i]));
                view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return URL.createObjectURL(new Blob([view], { type: 'audio/wav' }));
        }
    </script>
</body>
</html>

