<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI TTS Tiáº¿ng Viá»‡t - 12CTin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h1>AI Äá»c Tiáº¿ng Viá»‡t ğŸ‡»ğŸ‡³</h1>
    
    <div class="container">
        <label for="text-input">Nháº­p vÄƒn báº£n cáº§n Ä‘á»c:</label>
        <textarea id="text-input" placeholder="Nháº­p ná»™i dung vÃ o Ä‘Ã¢y...">Xin chÃ o, tÃ´i lÃ  trÃ­ tuá»‡ nhÃ¢n táº¡o chuyá»ƒn Ä‘á»•i vÄƒn báº£n thÃ nh Ã¢m thanh do Nguyá»…n LÃª ThÃ¡i DÆ°Æ¡ng vÃ  ÄoÃ n ThiÃªn An cá»§a 12CTin thá»±c hiá»‡n.</textarea>
        
        <button id="generate-btn" onclick="generateSpeech()" disabled>
            Äang táº£i mÃ´ hÃ¬nh...
        </button>
        
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="status" class="status">Äang khá»Ÿi táº¡o há»‡ thá»‘ng...</div>
        
        <audio id="audio-player" controls></audio>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';

        // Tá»‘i Æ°u cache
        env.useBrowserCache = true;
        env.allowLocalModels = false;

        const status = document.getElementById('status');
        const btn = document.getElementById('generate-btn');
        const progressBar = document.getElementById('progress-bar');
        const audioPlayer = document.getElementById('audio-player');

        let synthesizer = null;

        // Tá»± Ä‘á»™ng táº£i model
        async function preloadModel() {
            try {
                status.textContent = "Äang táº£i mÃ´ hÃ¬nh AI (Khoáº£ng 20MB)...";
                
                synthesizer = await pipeline('text-to-speech', 'Xenova/mms-tts-vie', {
                    quantized: true,
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            const percent = Math.round(data.progress || 0);
                            progressBar.style.width = percent + '%';
                            if(percent < 100) status.textContent = `Äang táº£i tÃ i nguyÃªn: ${percent}%`;
                        }
                    }
                });

                status.textContent = "Há»‡ thá»‘ng sáºµn sÃ ng!";
                status.style.color = "#00ffa3"; // MÃ u xanh khá»›p vá»›i CSS
                btn.textContent = "ğŸ”Š Äá»c vÄƒn báº£n ngay";
                btn.disabled = false;
                progressBar.style.width = '100%';
                
                // áº¨n thanh progress bar sau khi load xong cho gá»n
                setTimeout(() => { 
                    document.querySelector('.progress-container').style.opacity = '0';
                    document.querySelector('.progress-container').style.transition = 'opacity 1s';
                }, 1000);

            } catch (err) {
                console.error(err);
                status.textContent = "Lá»—i táº£i model: " + err.message;
                status.style.color = "#ff4d4d";
            }
        }

        preloadModel();

        window.generateSpeech = async function() {
            const text = document.getElementById('text-input').value;
            if (!text || !synthesizer) return;

            btn.disabled = true;
            btn.innerHTML = "â³ Äang xá»­ lÃ½..."; // ThÃªm icon loading
            status.textContent = "AI Ä‘ang táº¡o Ã¢m thanh...";
            status.style.color = "#aaa";
            audioPlayer.style.display = 'none';

            try {
                const output = await synthesizer(text);
                
                const wavUrl = createWavUrl(output.audio, output.sampling_rate);
                audioPlayer.src = wavUrl;
                audioPlayer.style.display = 'block';
                await audioPlayer.play();
                status.textContent = "HoÃ n táº¥t phÃ¡t Ã¢m thanh.";
                status.style.color = "#00ffa3";

            } catch (err) {
                console.error(err);
                status.textContent = "Lá»—i xá»­ lÃ½: " + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = "ğŸ”Š Äá»c vÄƒn báº£n ngay";
            }
        };

        function createWavUrl(audio, sampleRate) {
            const buffer = new ArrayBuffer(44 + audio.length * 2);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + audio.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, audio.length * 2, true);
            for (let i = 0; i < audio.length; i++) {
                let s = Math.max(-1, Math.min(1, audio[i]));
                view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return URL.createObjectURL(new Blob([view], { type: 'audio/wav' }));
        }
    </script>
</body>
</html>
